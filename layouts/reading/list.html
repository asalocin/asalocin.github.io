{{ define "main" }}
  <h1>{{ .Title }}</h1>
  <p>{{ .Content }}</p>

  <!-- NOW -->
  <h2 id="now">📖 Now</h2>
  {{ $now := where .Pages "Params.status" "now" }}
  {{ if gt (len $now) 0 }}
    <ul>
      {{ range $now }}
        <li>
          <strong><a href="{{ .RelPermalink }}">{{ .Title }}</a></strong> — {{ .Params.author }}
          {{ with .Params.progress }} · {{ . }}%{{ end }}
          {{ with .Params.summary }} · <em>{{ . }}</em>{{ end }}
        </li>
      {{ end }}
    </ul>
  {{ else }}<p><em>Nothing open right now.</em></p>{{ end }}

  <!-- FINISHED (star-sorted, like Gwern) -->
  <h2 id="finished">✅ Finished</h2>
  {{ $fin := where .Pages "Params.status" "finished" }}
  {{ if gt (len $fin) 0 }}
    {{ range sort (where $fin "Params.rating" "gt" 0) "Params.rating" "desc" }}
      <p>
        <strong><a href="{{ .RelPermalink }}">{{ .Title }}</a></strong>
        — {{ .Params.author }}
        {{ with .Params.rating }} · {{ strings.Repeat . "⭐" }}{{ end }}
        {{ with .Params.finished }} · <time>{{ . }}</time>{{ end }}<br/>
        {{ with .Params.summary }}<em>{{ . }}</em>{{ end }}
      </p>
    {{ end }}
  {{ else }}<p><em>No finishes yet.</em></p>{{ end }}

  <!-- TIMELINE -->
  <h2 id="timeline">🗓️ Timeline</h2>
  {{/* group by year-month of .Date or .Params.finished if present */}}
  {{ $all := .Pages }}
  {{ $byMonth := dict }}
  {{ range $all }}
    {{ $d := cond (isset .Params "finished") .Params.finished .Date }}
    {{ $key := time.Format "2006-01" (time $d) }}
    {{ $list := slice . }}
    {{ $cur := index $byMonth $key }}
    {{ if $cur }}{{ $byMonth = merge $byMonth (dict $key (append $cur .)) }}
    {{ else }}     {{ $byMonth = merge $byMonth (dict $key $list) }}
    {{ end }}
  {{ end }}
  {{ range $k, $v := $byMonth }}
    <h3>{{ $k }}</h3>
    <ul>
      {{ range $v }}
        <li><a href="{{ .RelPermalink }}">{{ .Title }}</a> — {{ .Params.author }}</li>
      {{ end }}
    </ul>
  {{ end }}

  <!-- TAGS -->
  <h2 id="tags">🏷️ Tags</h2>
  {{ with .Site.Taxonomies.tags }}
    <p>
      {{ range $tag, $pages := . }}
        <a href="{{ "/tags/" | relLangURL }}{{ $tag | urlize }}/">#{{ $tag }}</a> ({{ len $pages }}) ·
      {{ end }}
    </p>
  {{ end }}
{{ end }}
